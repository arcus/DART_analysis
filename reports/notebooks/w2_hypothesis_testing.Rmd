---
title: "Wave 2 Hypothesis Testing"
author: "Rose Hartman"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)

# load custom functions for plotting
source(here::here("src", "scripts", "functions_plotting.R"))

# if the figures directory doesn't exist, create it
dir.create(here::here("reports"), showWarnings = FALSE)
dir.create(here::here("reports", "figures"), showWarnings = FALSE)
```

`r if(!knitr::opts_chunk$get()$echo) ">Note that code chunks are not printed in this report in order to keep the output tidy. To see all of the code to generate these results, open the .Rmd file."`

This report executes the tests from [our preregistration](https://osf.io/zmnr6). 
Text that appears as quotes in this report is taken verbatim from the preregistration.

## Hypotheses to test

> 1. Learners' self-ratings of their own ability to perform data science tasks will increase over the course of the program (pre to post).
> 2. Learners' self-ratings of their agreement with important tenets of open science will increase over the course of the program (pre to post).
> 3. Change in 1 and 2 will be stronger for learners who report higher levels of engagement in the program. 
> 
> Additional hypotheses:
>
> 4. Change in 1 and 2 will be higher for learners who report higher levels of agreement with the statement "Self-paced asynchronous studying works well for me in general"
> 5. Change in 1 and 2 will be higher for learners who report higher average levels of agreement with the statements about the appropriateness of their assigned pathway ("The skills and topics I was hoping to learn were covered in my modules", "My assigned modules worked together well as a learning pathway", "My assigned modules were appropriate to my skill level", "I learned things from my assigned modules that I can apply in my research", and "The assigned modules for my pathway were relevant to my learning goals")


```{r load_data}
waves <- readr::read_csv(here::here("participant_waves.csv"), show_col_types = FALSE)

nih_pre <- readRDS(here::here("data", "deidentified", "nih_pre.rds")) |> 
  dplyr::left_join(waves, by = "record_id") |> 
  dplyr::filter(wave == 2) |> 
  dplyr::mutate(event = "pre")
nih_post <- readRDS(here::here("data", "deidentified", "nih_post.rds")) |> 
  dplyr::left_join(waves, by = "record_id") |> 
  dplyr::filter(wave == 2)|> 
  dplyr::mutate(event = "post")
nih <- dplyr::bind_rows(nih_post, nih_pre)

exit <- readRDS(here::here("data", "deidentified", "exit_survey.rds")) |> 
  dplyr::left_join(waves, by = "record_id") |> 
  dplyr::filter(wave == 2)

nalms <- readRDS(here::here("data", "deidentified", "nalms_summary.rds")) |>
  dplyr::left_join(waves, by = "record_id") |> 
  dplyr::filter(wave == 2) |> 
  dplyr::left_join(readRDS(here::here("data", "deidentified", "nalms_pathway_info.rds")), by = "pathway")
```

This data includes `r nrow(nih_pre)` records for the NIH items (ability and open science variables) at pretest, and `r nrow(nih_post)` at post test. 
There are `r nrow(exit)` exit survey records (asynchronous learning preference and pathway fit variables).
There are `r length(unique(nalms$record_id))` NALMS records (used to calculate engagement), but note that only `r length(unique(dplyr::filter(nalms, redcap_repeat_instance > 1)$record_id))` actually show any activity from participants.

## Define variables

> For all mean scores, the mean will be computed on available data (i.e. using na.rm = TRUE).

> ability_pre and ability_post are the mean of participants' ratings (assessed pre- or post-program, respectively) on the following items from survey2: all items under the instructions "please rate your ability to complete the following tasks". 
>
> openscience_pre and openscience_post are the mean of participants' ratings (assessed pre- or post-program, respectively) on the following items from survey2: all items under the heading "please rate your level of agreement with the following statements"

```{r}
data <- nih |> 
  dplyr::mutate(dplyr::across(tidyselect::where(is.factor), as.numeric)) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(ability = mean(dplyr::c_across(findable:atomize), na.rm = TRUE),
                openscience = mean(dplyr::c_across(data_storage_1:code_efficient), na.rm = TRUE)) |> 
  dplyr::select(record_id, ability, openscience, event) |> 
  tidyr::pivot_wider(names_from = event, values_from = c(ability, openscience)) |> 
  dplyr::mutate(ability_change = ability_post - ability_pre, 
                openscience_change = openscience_post - openscience_pre)
```

> Engagement is defined as number of modules marked complete out of total modules assigned as of the last day of the program (12am Eastern 2023-11-27). 

```{r}
engagement <- nalms |> 
  dplyr::filter(timestamp < lubridate::ymd("2023-11-27")) |> 
  dplyr::group_by(record_id) |> 
  dplyr::slice_max(timestamp) |> 
  dplyr::mutate(engagement = n_modules_done / pathway_n_modules) |> 
  dplyr::select(record_id, engagement, pathway)

# add engagement to data
data <- dplyr::left_join(data, engagement, by = "record_id")
```


> Asynchronous learning preference is participants' level of agreement (1strongly disagree - 5 strongly agree) with the statement "Self-paced asynchronous studying works well for me in general". 

> Pathway fit is the mean of participants' level of agreement (1strongly disagree - 5 strongly agree) with the following five statements: "The skills and topics I was hoping to learn were covered in my modules", "My assigned modules worked together well as a learning pathway", "My assigned modules were appropriate to my skill level", "I learned things from my assigned modules that I can apply in my research", "The assigned modules for my pathway were relevant to my learning goals")

```{r}
asynch_and_pathway_fit <- exit |> 
  dplyr::mutate(dplyr::across(tidyselect::where(is.factor), as.numeric)) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(pathway_fit = mean(c(module_expectations, fit_expertise, coherent_pathway, fit_relevance, fit_learn), na.rm = TRUE)) |> 
  dplyr::select(record_id, pathway_fit, asynch)

# Add exit data 
data <- dplyr::left_join(data, asynch_and_pathway_fit, by = "record_id")
```

```{r}
# reorder columns, just for nicer printing
data <- data |> 
  dplyr::select(record_id, pathway, tidyselect::everything())

# show a summary
summary(data)
```


# Preregistered hypothesis tests

> All central hypotheses tested with mixed effects change-score models, with a random effect of cluster (change = post - pre), one model on change scores for ability and one on change scores for open science tenets. Another model including the effect of moderators as a covariate. For example:
>
> ```
> lme4::lmer(change ~ 1 + (1|cluster), data)
> lme4::lmer(change ~ 1 + engagement + (1 + engagement|cluster), data)
> lme4::lmer(change ~ 1 + asynch + (1 + asynch|cluster), data)
> lme4::lmer(change ~ 1 + pathway_fit + (1 + pathway_fit|cluster), data)
> ```
> 
> If models with random slopes do not converge, drop the random slopes and include only a random intercept for cluster. 
> 
> If random intercepts model does not converge, run linear model with cluster as a fixed effect, and omitting cluster altogether:
> 
> ```
> lm(change ~ cluster, data = data)
> lm(change ~ 1, data = data)
> lm(change ~ cluster*engagement, data = data)
> lm(change ~ engagement, data = data)
> lm(change ~ cluster*asynch, data = data)
> lm(change ~ asynch, data = data)
> lm(change ~ cluster*pathway_fit, data = data)
> lm(change ~ pathway_fit, data = data)
> ```
> 
> Whether or not mixed models work, also run plain dependent samples t-test ignoring grouping by cluster:
> 
> ```
> t.test(x=data$pre, y=data$post, paired = TRUE)
> ```

> p values for mixed effects models calculated using Satterthwaite approximation (lmerTest package in R)

## Hypothesis 1

> 1. Learners' self-ratings of their own ability to perform data science tasks will increase over the course of the program (pre to post).

```{r}
h1 <- lme4::lmer(ability_change ~ 1+ (1|pathway), data)
summary(h1)

t.test(y=data$ability_pre, x=data$ability_post, paired = TRUE)
```

## Hypothesis 2

> 2. Learners' self-ratings of their agreement with important tenets of open science will increase over the course of the program (pre to post).

```{r}
h2 <- lme4::lmer(openscience_change ~ 1+ (1|pathway), data)
summary(h2)

t.test(y=data$openscience_pre, x=data$openscience_post, paired = TRUE)
```

## Hypothesis 3

> 3. Change in 1 and 2 will be stronger for learners who report higher levels of engagement in the program.

```{r h3_ability}
h3_ability <- lme4::lmer(ability_change ~ 1 + engagement + (1+ engagement|pathway), data)
summary(h3_ability)

anova(h3_ability, h1)
```

```{r h3_openscience}
h3_openscience <- lme4::lmer(openscience_change ~ 1 + engagement + (1+ engagement|pathway), data) # boundary (singular) fit: see ?isSingular
h3_openscience <- lme4::lmer(openscience_change ~ 1 + engagement + (1|pathway), data)
summary(h3_openscience)

anova(h3_openscience, h2)
```

## Hypothesis 4

> 4. Change in 1 and 2 will be higher for learners who report higher levels of agreement with the statement "Self-paced asynchronous studying works well for me in general"

```{r h4_ability}
h4_ability <- lme4::lmer(ability_change ~ 1 + asynch + (1 + asynch|pathway), data)
h4_ability <- lme4::lmer(ability_change ~ 1 + asynch + (1 |pathway), data)
summary(h4_ability)
```

```{r h4_openscience}
h4_openscience <- lme4::lmer(openscience_change ~ 1 + asynch + (1 |pathway), data)
h4_openscience <- lme4::lmer(openscience_change ~ 1 + asynch + (1 + asynch|pathway), data)
summary(h4_openscience)
```

## Hypothesis 5

> 5. Change in 1 and 2 will be higher for learners who report higher average levels of agreement with the statements about the appropriateness of their assigned pathway ("The skills and topics I was hoping to learn were covered in my modules", "My assigned modules worked together well as a learning pathway", "My assigned modules were appropriate to my skill level", "I learned things from my assigned modules that I can apply in my research", and "The assigned modules for my pathway were relevant to my learning goals")

```{r h5_ability}
h5_ability <- lme4::lmer(ability_change ~ 1 + pathway_fit + (1 + pathway_fit|pathway), data)
h5_ability <- lme4::lmer(ability_change ~ 1 + pathway_fit + (1 |pathway), data)
summary(h5_ability)
```

```{r h5_openscience}
h5_openscience <- lme4::lmer(openscience_change ~ 1 + pathway_fit + (1 + pathway_fit|pathway), data)
summary(h5_openscience)
```

# Plots

```{r plot_data}
plot_data <- data |> 
  tidyr::pivot_longer(cols=tidyselect::starts_with(c("ability","openscience"))) |> 
  tidyr::separate(name, into=c("measure", "event"), sep="_") |> 
  tidyr::pivot_wider(names_from = measure, values_from = value) |> 
  dplyr::mutate(event = factor(event, levels = c("pre", "post", "change")))

plot_data_means <- plot_data |> 
  dplyr::filter(event %in% c("pre", "post")) |> 
  dplyr::group_by(event) |> 
  dplyr::summarise(ability = mean(ability), 
                   openscience = mean(openscience))
```

```{r define_base_plots}
ability_plot <- plot_data |> 
  dplyr::filter(event %in% c("pre", "post")) |> 
  ggplot(aes(y=ability)) + 
  scale_y_continuous(breaks = 1:4, limits = c(1,4),
                     labels = c("(1) I wouldn't know where to start",
                                "(2) I could struggle through,\nbut not confident I could do it",
                                "(3) I could probably do it\nwith some trial and error",
                                "(4) I am confident in my ability to do it")) + 
  labs(x=NULL, y=NULL, 
       title = "Ability")

openscience_plot <- plot_data |> 
  dplyr::filter(event %in% c("pre", "post")) |> 
  ggplot(aes(y=openscience)) + 
  scale_y_continuous(breaks = 1:7, limits = c(1,7),
                     labels = c("(1) Strongly Disagree",
                                "(2) Disagree",
                                "(3) Somewhat Disagree",
                                "(4) Neither Agree nor Disagree",
                                "(5) Somewhat Agree",
                                "(6) Agree", 
                                "(7) Strongly Agree")) + 
  labs(x=NULL, y=NULL, 
       title = "Open Science Values")
```


## Distributions and summary stats for all key variables

```{r n_per_pathway}
data |> 
  dplyr::select(pathway) |> 
  gtsummary::tbl_summary()
```

```{r summary_stats_tables}
# outcomes
data |> 
  dplyr::select(record_id, 
                ability_pre, ability_post, ability_change, 
                openscience_pre, openscience_post, openscience_change) |>
  tidyr::pivot_longer(-record_id) |> 
  tidyr::separate(col = name, into = c("name", "event"), sep = "_") |> 
  tidyr::pivot_wider(names_from = name, values_from = value) |> 
  dplyr::select(-record_id) |> 
  gtsummary::tbl_summary(by = event)

# covariates
data |> 
  dplyr::select(engagement, pathway_fit, asynch) |>
  gtsummary::tbl_summary(type = list(asynch ~ "continuous"))
```

```{r}
(ability_plot + 
  geom_histogram(bins = 30) + 
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) + 
  facet_wrap(~event, ncol = 1)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "ability_pre_post_hist.png",
                 width = 3,
                 height = 7)
```



```{r}
(openscience_plot + 
  geom_histogram() + 
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) + 
  facet_wrap(~event, ncol = 1)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "openscience_pre_post_hist.png",
                 width = 3,
                 height = 7)
```

```{r}
(data |> 
  tidyr::pivot_longer(tidyselect::ends_with("_change")) |> 
  ggplot(aes(x=value)) + 
  geom_histogram() + 
  facet_wrap(~name, ncol = 1) + 
  geom_vline(xintercept = 0, linetype = 2)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "change_hist.png",
                 width = 3,
                 height = 5)
```


## Change in ability from pre to post

```{r}
(ability_plot + 
  geom_boxplot(aes(x=event), fill = chop_blue)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "ability_boxplot.png",
                 width = 5,
                 height = 3.5)

(ability_plot + 
  geom_line(aes(x=event, group = record_id), alpha = .4)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "ability_lineplot.png",
                 width = 5,
                 height = 3.5)
```


Let's look at the relationship between engagement and change in ability by pathway.

```{r}
(data |> 
  ggplot(aes(x = engagement, y = ability_change, color = pathway)) + 
  geom_point(show.legend = FALSE) + 
  stat_smooth(method = "lm") + 
  facet_wrap(~pathway)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "ability_change_by_pathway.png",
                 width = 5,
                 height = 5)
```


## Change in open science from pre to post

```{r}
(openscience_plot + 
  geom_boxplot(aes(x=event), fill = chop_blue)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "openscience_boxplot.png",
                 width = 5,
                 height = 3.5)

(openscience_plot + 
  geom_line(aes(x=event, group = record_id), alpha = .4)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "openscience_lineplot.png",
                 width = 5,
                 height = 3.5)
```


Let's look at the relationship between engagement and change in open science by pathway.

```{r}
(data |> 
  ggplot(aes(x = engagement, y = openscience_change, color = pathway)) + 
  geom_point(show.legend = FALSE) + 
  stat_smooth(method = "lm") + 
  facet_wrap(~pathway)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "openscience_change_by_pathway.png",
                 width = 5,
                 height = 5)
```


```{r}
(data |> 
  ggplot(aes(y=ability_change, x = openscience_change))  +
  geom_point(alpha = .5)) |> 
  # the save_and_print function is defined in functions_plotting.R
  save_and_print(filename = "openscience_change_by_ability_change.png",
                 width = 5,
                 height = 5)
```

